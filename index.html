<!DOCTYPE html>
<html>
<head>
    <title>A-Frame Avatar AR/VR Mejorado</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.0/dist/aframe-extras.min.js"></script>
</head>
<body>
    <a-scene
        xr-mode-ui="XRMode: xr;"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
        <a-assets timeout="30000">
            <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"></a-asset-item>
            <!-- HDRI fondo VR -->
            <img id="skyTexture" src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@master/examples/textures/equirectangular/royal_esplanade_1k.hdr">
        </a-assets>

        <!-- Avatar dinámico -->
        <a-entity id="avatar"
                  gltf-model="#avatarModel"
                  scale="0.5 0.5 0.5"
                  animation-mixer
                  shadow="cast: true; receive: true"
                  look-at="[camera]"
                  visible="false">
        </a-entity>

        <!-- Hit test para AR -->
        <a-entity id="hit-test" ar-hit-test></a-entity>

        <!-- Cámara -->
        <a-camera id="camera" position="0 1.6 0" look-controls></a-camera>

        <!-- Luces -->
        <a-light type="ambient" color="#cccccc" intensity="0.8"></a-light>
        <a-light type="directional" color="#ffffff" intensity="1.0" position="-2 4 2"></a-light>

        <!-- Fondo VR -->
        <a-sky id="sky" src="#skyTexture" rotation="0 -90 0"></a-sky>

        <!-- Script para AR y ajuste de avatar -->
        <script>
            AFRAME.registerComponent('ar-hit-test', {
                tick: function () {
                    const avatar = document.querySelector('#avatar');
                    const cameraEl = document.querySelector('#camera');
                    const hitTest = this.el.sceneEl.hitTest;

                    if (hitTest && hitTest.visible) {
                        // Posición sobre el suelo detectado
                        avatar.object3D.position.copy(hitTest.position);
                        avatar.visible = true;

                        // Escala automática según la distancia al suelo (más natural)
                        let distance = cameraEl.object3D.position.distanceTo(hitTest.position);
                        let scaleFactor = Math.min(Math.max(distance / 4, 0.3), 1.2); // Ajusta mínimo y máximo
                        avatar.object3D.scale.set(scaleFactor, scaleFactor, scaleFactor);

                        // Mirar siempre a la cámara
                        avatar.object3D.lookAt(cameraEl.object3D.position);
                    }
                }
            });
        </script>
    </a-scene>
</body>
</html>
