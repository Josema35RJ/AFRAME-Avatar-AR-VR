<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>VR + AR Profesional Multi-Dispositivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

  <!-- Extras -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

  <!-- Model Viewer para iOS AR -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    body { margin:0; overflow:hidden; }
    #arMessage { 
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.6); color:white; padding:10px 20px;
      font-family:sans-serif; border-radius:8px; display:none; z-index:10;
    }
    model-viewer { display:none; width:100%; height:100%; position:fixed; top:0; left:0; }
  </style>
</head>
<body>
<div id="arMessage">Usa Chrome en Android para AR</div>

<!-- iOS Quick Look -->
<model-viewer
  id="iosAR"
  src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"
  ar
  ar-modes="quick-look"
  camera-controls
></model-viewer>

<!-- A-Frame Scene -->
<a-scene id="aframeScene" embedded webxr="optionalFeatures: hit-test; requiredFeatures: local-floor;" renderer="colorManagement: true;">
  <a-assets>
    <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"></a-asset-item>
  </a-assets>

  <!-- Cámara -->
  <a-camera position="0 1.6 0" look-controls wasd-controls></a-camera>

  <!-- Avatar -->
  <a-entity id="avatar" gltf-model="#avatarModel" scale="1 1 1" animation-mixer position="0 0 -2"></a-entity>

  <!-- Sky VR -->
  <a-sky src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg"></a-sky>

  <!-- Environment VR -->
  <a-entity environment="preset: default; ground: hills; groundColor: #f4e2d8; skyType: gradient; skyColor: #88ccee; dressing: trees; dressingAmount: 20; dressingColor: #228B22"></a-entity>

  <!-- Luces -->
  <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
  <a-light type="directional" position="0 5 5" intensity="1"></a-light>
</a-scene>

<script>
  const sceneEl = document.querySelector('#aframeScene');
  const avatarEl = document.querySelector('#avatar');
  const iosAR = document.querySelector('#iosAR');
  const arMessage = document.querySelector('#arMessage');

  // Detectar iOS
  const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  // Detectar soporte AR WebXR
  const checkWebXRAR = async () => {
    if (navigator.xr) {
      return await navigator.xr.isSessionSupported('immersive-ar');
    }
    return false;
  };

  const init = async () => {
    const webxrAR = await checkWebXRAR();

    if (isiOS) {
      // iOS → Quick Look
      sceneEl.style.display = 'none';
      iosAR.style.display = 'block';
      arMessage.style.display = 'none';
    } else if (webxrAR) {
      // Android Chrome → AR con hit-test
      iosAR.style.display = 'none';
      arMessage.style.display = 'none';
      avatarEl.setAttribute('visible', false);

      // Retícula
      const cursor = document.createElement('a-entity');
      cursor.setAttribute('geometry', {primitive:'ring', radiusInner:0.05, radiusOuter:0.06});
      cursor.setAttribute('material', {color:'#00ff88', shader:'flat', opacity:0.7});
      cursor.setAttribute('rotation','-90 0 0');
      cursor.setAttribute('visible', false);
      sceneEl.appendChild(cursor);

      let hitTestSource = null;
      let localSpace = null;
      let lastHit = null;
      let placed = false;

      sceneEl.renderer.xr.addEventListener('sessionstart', async () => {
        const session = sceneEl.renderer.xr.getSession();
        if (!session) return;

        localSpace = await session.requestReferenceSpace('local-floor');
        const viewerSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({space: viewerSpace});

        const onXRFrame = (time, frame) => {
          const viewerPose = frame.getViewerPose(localSpace);
          if (!viewerPose) return;

          const hitResults = frame.getHitTestResults(hitTestSource);
          if (hitResults.length > 0) {
            const hitPose = hitResults[0].getPose(localSpace);
            cursor.object3D.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
            cursor.setAttribute('visible', !placed);
            lastHit = hitPose.transform.position;
          } else {
            cursor.setAttribute('visible', false);
          }
          session.requestAnimationFrame(onXRFrame);
        };
        session.requestAnimationFrame(onXRFrame);

        session.addEventListener('select', () => {
          if (!lastHit) return;
          avatarEl.object3D.position.set(lastHit.x, lastHit.y + 0.01, lastHit.z);
          avatarEl.setAttribute('visible', true);
          placed = true;
          cursor.setAttribute('visible', false);
        });
      });

    } else {
      // Otros → fallback VR
      iosAR.style.display = 'none';
      arMessage.style.display = 'block';
      avatarEl.setAttribute('visible', true);
    }
  };

  init();
</script>
</body>
</html>
