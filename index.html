<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR + AR Profesional MultiDispositivo</title>

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

  <!-- Modelo Viewer para AR iOS -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Componente hide-in-ar -->
  <script>
    AFRAME.registerComponent('hide-in-ar', {
      init: function () {
        const el = this.el;
        el.setAttribute('visible', true);
        this.el.sceneEl.addEventListener('enter-vr', () => {
          const xrSession = this.el.sceneEl.renderer.xr.getSession();
          const isAR = xrSession && xrSession.environmentBlendMode === 'alpha-blend';
          if (isAR) el.setAttribute('visible', false);
        });
        this.el.sceneEl.addEventListener('exit-vr', () => { el.setAttribute('visible', true); });
      }
    });
  </script>

  <!-- Componente AR placement para Android Chrome -->
  <script>
    AFRAME.registerComponent('ar-place-avatar', {
      init: function () {
        const el = this.el;
        const scene = el.sceneEl;

        // fallback: mostrar avatar en VR/PC
        if (!AFRAME.utils.device.checkHeadsetConnected()) {
          el.setAttribute('visible', true);
        }

        // Retícula de previsualización
        const cursor = document.createElement('a-entity');
        cursor.setAttribute('geometry', {primitive:'ring', radiusInner:0.05, radiusOuter:0.06});
        cursor.setAttribute('material', {color:'#00ff88', shader:'flat', opacity:0.7});
        cursor.setAttribute('rotation','-90 0 0');
        cursor.setAttribute('visible', false);
        scene.appendChild(cursor);

        // Sombra simple
        const shadow = document.createElement('a-plane');
        shadow.setAttribute('rotation','-90 0 0');
        shadow.setAttribute('material',{color:'#000', opacity:0.3, transparent:true, shader:'flat'});
        shadow.setAttribute('scale','0.5 0.5 1');
        shadow.setAttribute('visible', false);
        scene.appendChild(shadow);

        let hitTestSource = null;
        let localSpace = null;
        let lastHit = null;
        let placed = false;

        scene.renderer.xr.addEventListener('sessionstart', async () => {
          const session = scene.renderer.xr.getSession();
          if (!session) return;

          localSpace = await session.requestReferenceSpace('local-floor');
          const viewerSpace = await session.requestReferenceSpace('viewer');
          hitTestSource = await session.requestHitTestSource({space: viewerSpace});

          const onXRFrame = (time, frame) => {
            const viewerPose = frame.getViewerPose(localSpace);
            if (!viewerPose) return;

            const hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
              const hitPose = hitTestResults[0].getPose(localSpace);
              cursor.object3D.position.set(hitPose.transform.position.x, hitPose.transform.position.y, hitPose.transform.position.z);
              cursor.setAttribute('visible', !placed);
              lastHit = hitPose.transform.position;
            } else {
              cursor.setAttribute('visible', false);
            }

            session.requestAnimationFrame(onXRFrame);
          };
          session.requestAnimationFrame(onXRFrame);

          // Tap para colocar avatar
          session.addEventListener('select', () => {
            if (!lastHit) return;
            el.object3D.position.set(lastHit.x, lastHit.y + 0.01, lastHit.z);
            el.setAttribute('visible', true);
            shadow.object3D.position.set(lastHit.x, lastHit.y, lastHit.z);
            shadow.setAttribute('visible', true);
            placed = true;
            cursor.setAttribute('visible', false);
          });
        });
      }
    });
  </script>
</head>

<body>
  <a-scene
    id="scene"
    webxr="optionalFeatures: hit-test; requiredFeatures: local-floor;"
    xr-mode-ui="enabled: true"
    renderer="colorManagement: true;"
  >
    <a-assets>
      <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"></a-asset-item>
    </a-assets>

    <!-- Cámara -->
    <a-camera position="0 1.6 0" look-controls wasd-controls></a-camera>

    <!-- Avatar VR/AR -->
    <a-entity
      id="avatar"
      gltf-model="#avatarModel"
      position="0 0 -2"
      scale="1 1 1"
      animation-mixer
      visible="false"
      ar-place-avatar
    ></a-entity>

    <!-- Fallback AR iOS: model-viewer -->
    <model-viewer
      id="iosAvatar"
      src="https://cdn.jsdelivr.net/gh/Josema35RJ/Avatar@main/3dpea.com_Salute.glb"
      ar
      ar-modes="quick-look"
      camera-controls
      style="position: fixed; bottom: 0; width: 100%; height: 100%; display: none;"
    ></model-viewer>

    <!-- Cielo VR -->
    <a-sky
      src="url(https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg)"
      rotation="0 -130 0"
      hide-in-ar
    ></a-sky>

    <!-- Entorno VR -->
    <a-entity
      environment="preset: default; ground: hills; groundColor: #f4e2d8; skyType: gradient; skyColor: #88ccee; dressing: trees; dressingAmount: 20; dressingColor: #228B22"
      hide-in-ar
    ></a-entity>

    <!-- Luces -->
    <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
    <a-light type="directional" position="0 5 5" intensity="1"></a-light>
  </a-scene>

  <script>
    // Detectar iOS y mostrar model-viewer si no hay WebXR AR
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) {
      document.querySelector('a-scene').style.display = 'none';
      const mv = document.querySelector('#iosAvatar');
      mv.style.display = 'block';
    }
  </script>
</body>
</html>
